<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="address-autocomplete">
  <template>
    <style>
      :host {
        font-family: sans-serif;
        margin-top: 3rem;
        display: block;
        width: auto;
      };
      #inputGroup {
        display: flex;
      }
      #searchAddress {
        border: none; border-bottom: 1px solid darkblue; width: auto; display: inline-block; height: 30px;
        flex: 9 auto;
      }
      .icon{
        display: none;
      }
      span{
        margin-right: 2rem;
      }
      #dictate {
        float: right;
        width: 32px;
        display: none;
      }
      #recommendedaddresslist li{
        list-style-type: none;
        margin-bottom: 0.5rem;
      }
    </style>
    <div id="inputGroup">
      <input id="searchAddress" onkeyup="getAddresses(this.value);" onchange="getAddresses(this.value);" placeholder="please enter Address">
      <span id="dictate" onclick="startDictation();">
        <img src="https://cdn4.iconfinder.com/data/icons/eldorado-devices/40/microphone-32.png">
      </span>
    </div>
    <div id="recommendedaddresslist"></div>
  </template>

  <script>
  document._currentScript = document._currentScript || document.currentScript;
  let recommendedaddresslist = {};
  let searchAddress = {};
  let selectedAddress = {};
  let processFuntion = "";

  function createAddressList(search) {
    return new Promise(function(resolve, reject) {
      fetch('https://photon.komoot.io/api/?q='+ search)
        .then(function(response) {
          return response.json();
        })
        .then(function(j) {
          addressList = "";
          addressList += '<ul>'
          Object.keys(j.features).forEach(function(item){
            // addressList += '<li conclick="returnAddress(' + j.features[item].properties + ')">'
            addressList += '<li id="'+j.features[item].properties.osm_id+'" onclick="returnSelectedAddress(\'' + encodeURIComponent(JSON.stringify(j.features[item].properties)) + '\')">'
            addressList += (j.features[item].properties.name == undefined || j.features[item].properties.name === j.features[item].properties.street || j.features[item].properties.street == undefined) ? '' : '<b>' + j.features[item].properties.name + ' </b>'
            addressList += (j.features[item].properties.name == undefined || j.features[item].properties.name === j.features[item].properties.street) ? '' : '' + j.features[item].properties.name + ' '
            // addressList += (j.features[item].properties.country == undefined) ? '' : ' '+ j.features[item].properties.country
            // addressList += (j.features[item].properties.state == undefined) ? '' : ' '+ j.features[item].properties.state
            addressList += (j.features[item].properties.postcode == undefined) ? '' : ' '+ j.features[item].properties.postcode
            addressList += (j.features[item].properties.city == undefined) ? '' : ' '+ j.features[item].properties.city
            addressList += (j.features[item].properties.street == undefined) ? '' : ' ' + j.features[item].properties.street
            addressList += (j.features[item].properties.housenumber == undefined) ? ' ' : ' ' + j.features[item].properties.housenumber
            // addressList += '' + j.features[item].properties.osm_value
            addressList += '</li>'
          });
          addressList += '</ul>'
          resolve(addressList);
        });
      });
  };

    Polymer({
      is: 'address-autocomplete',
      properties: {
        processaddressfunction: String
      },
      ready: function() {
        recommendedaddresslist = this.$.recommendedaddresslist;
        searchAddress = this.$.searchAddress;
        processFuntion = this.processaddressfunction || 'setAddress';
        if (window.hasOwnProperty('webkitSpeechRecognition')) {
          this.$.dictate.style = 'display: inline-block';
        };
      }
    })

    function returnSelectedAddress(selectedAddress) {
      recommendedaddresslist.innerHTML = '';
      window[processFuntion](JSON.parse(decodeURIComponent(selectedAddress)));
    }

    function getAddresses(searchstring) {
      if (searchstring.length > 3 ) {
        let myaddress = createAddressList(searchstring).then(function(myaddress) {
          recommendedaddresslist.innerHTML = myaddress;
        })
        let listitems = Polymer.dom(recommendedaddresslist).querySelectorAll('li');
        listitems.forEach(function(item) {
          //console.log(item);
        })
      }
    }

    function startDictation() {
      if (window.hasOwnProperty('webkitSpeechRecognition')) {
        searchAddress.style = "background: rgb(255, 170, 170);";
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "de-DE";
        recognition.start();
        recognition.onresult = function(e) {
          searchAddress.value = e.results[0][0].transcript;
          recognition.stop();
          searchAddress.style = "background: none;";
          getAddresses(searchAddress.value);
          //document.getElementById('labnol').submit();
        };
        recognition.onerror = function(e) {
          recognition.stop();
          searchAddress.style = "background: none;";
        }
      }
    }
    </script>
</dom-module>
